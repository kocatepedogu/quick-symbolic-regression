#!/bin/sh

FLAGS=""
FLAGS="$FLAGS -Wno-format-security"
FLAGS="$FLAGS -g --std=c++20 -fopenmp -O3"

hipcc -c -fPIC expressions/expression.cc -o expressions/expression.o $FLAGS
hipcc -c -fPIC expressions/binary.cc -o expressions/binary.o $FLAGS

hipcc -c -fPIC compiler/ir.cc -o compiler/ir.o $FLAGS
hipcc -c -fPIC compiler/compiler.cc -o compiler/compiler.o $FLAGS

hipcc -c -fPIC dataset/dataset.cc -o dataset/dataset.o $FLAGS

hipcc -c -fPIC intra-individual/vm/vm.hip -o intra-individual/vm/vm.o $FLAGS
hipcc -c -fPIC intra-individual/program/program.cc -o intra-individual/program/program.o $FLAGS
hipcc -c -fPIC intra-individual/runner.cc -o intra-individual/runner.o $FLAGS

hipcc -c -fPIC inter-individual/vm/vm.hip -o inter-individual/vm/vm.o $FLAGS
hipcc -c -fPIC inter-individual/program/program.cc -o inter-individual/program/program.o $FLAGS
hipcc -c -fPIC inter-individual/runner.cc -o inter-individual/runner.o $FLAGS

hipcc -c -fPIC tests/testdata.cc -o tests/testdata.o $FLAGS

hipcc expressions/expression.o \
      expressions/binary.o \
      \
      compiler/ir.o \
      compiler/compiler.o \
      \
      dataset/dataset.o \
      \
      intra-individual/vm/vm.o \
      intra-individual/program/program.o \
      intra-individual/runner.o \
      \
      inter-individual/vm/vm.o \
      inter-individual/program/program.o \
      inter-individual/runner.o \
      \
      tests/testdata.o \
      -shared -o quicksr.so $FLAGS

cd tests

hipcc testinter.cc -L.. -l:quicksr.so -o testinter.exe $FLAGS && LD_LIBRARY_PATH=".." ./testinter.exe
hipcc testintra.cc -L.. -l:quicksr.so -o testintra.exe $FLAGS && LD_LIBRARY_PATH=".." ./testintra.exe

cd ..

rm dataset/*.o
rm compiler/*.o
rm expressions/*.o
rm tests/*.o

rm intra-individual/program/*.o
rm intra-individual/vm/*.o
rm intra-individual/*.o

rm inter-individual/program/*.o
rm inter-individual/vm/*.o
rm inter-individual/*.o
